<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puissance 4</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body> 
    <h1 class="title">Puissance 4</h1>
    <div class="players-row">
    <section class="pion-selection">
    <h2>Joueur 1 : choisissez votre jeton</h2>
    <form method="post" action="/joueur" enctype="multipart/form-data">
        <input type="hidden" name="joueur" value="1">
        <div class="pions-1">
            <label><input type="radio" name="pion" value="sdm.jpg" required {{if inSlice "pawn1.svg" .TakenPawns}}disabled{{end}}> <img src="../images/sdm.jpg" alt="SDM" width="64"></label>
            <label><input type="radio" name="pion" value="kaaris.webp" {{if inSlice "pawn2.svg" .TakenPawns}}disabled{{end}}> <img src="../images/kaaris.webp" alt="Karis" width="64"></label>
            <label><input type="radio" name="pion" value="booba.png" {{if inSlice "pawn3.svg" .TakenPawns}}disabled{{end}}> <img src="../images/booba.png" alt="Booba" width="64"></label>
            <label><input type="radio" name="pion" value="naps.jpg" {{if inSlice "pawn4.svg" .TakenPawns}}disabled{{end}}> <img src="../images/naps.jpg" alt="Naps" width="64"></label>
            <label><input type="radio" name="pion" value="damso.jpg" {{if inSlice "pawn5.svg" .TakenPawns}}disabled{{end}}> <img src="../images/damso.jpg" alt="Damso" width="64"></label>
            <label><input type="radio" name="pion" value="tiako.jpg" {{if inSlice "pawn6.svg" .TakenPawns}}disabled{{end}}> <img src="../images/tiako.jpg" alt="Tiako" width="64"></label>
            <label><input type="radio" name="pion" value="leto.jpg" {{if inSlice "pawn7.svg" .TakenPawns}}disabled{{end}}> <img src="../images/leto.jpg" alt="Leto" width="64"></label>
            <label><input type="radio" name="pion" value="plk.jpg" {{if inSlice "pawn8.svg" .TakenPawns}}disabled{{end}}> <img src="../images/plk.jpg" alt="PLK" width="64"></label>
            <label><input type="radio" name="pion" value="niska.jpg" {{if inSlice "pawn9.svg" .TakenPawns}}disabled{{end}}> <img src="../images/niska.jpg" alt="Niska" width="64"></label>
            <label><input type="radio" name="pion" value="jul.jpg" {{if inSlice "pawn10.svg" .TakenPawns}}disabled{{end}}> <img src="../images/jul.jpg" alt="Jul" width="64"></label>
        </div>
        <button type="submit">Valider Joueur 1</button>
    </form>
    </section>
    <section class="pion-selection">
    <h2>Joueur 2 : choisissez votre jeton</h2>
    <form method="post" action="/joueur" enctype="multipart/form-data">
        <input type="hidden" name="joueur" value="2">
        <div class="pions-2">
            <label><input type="radio" name="pion" value="sdm.jpg" required {{if inSlice "pawn1.svg" .TakenPawns}}disabled{{end}}> <img src="../images/sdm.jpg" alt="SDM" width="64"></label>
            <label><input type="radio" name="pion" value="kaaris.webp" {{if inSlice "pawn2.svg" .TakenPawns}}disabled{{end}}> <img src="../images/kaaris.webp" alt="Karis" width="64"></label>
            <label><input type="radio" name="pion" value="booba.png" {{if inSlice "pawn3.svg" .TakenPawns}}disabled{{end}}> <img src="../images/booba.png" alt="Booba" width="64"></label>
            <label><input type="radio" name="pion" value="naps.jpg" {{if inSlice "pawn4.svg" .TakenPawns}}disabled{{end}}> <img src="../images/naps.jpg" alt="Naps" width="64"></label>
            <label><input type="radio" name="pion" value="damso.jpg" {{if inSlice "pawn5.svg" .TakenPawns}}disabled{{end}}> <img src="../images/damso.jpg" alt="Damso" width="64"></label>
            <label><input type="radio" name="pion" value="tiako.jpg" {{if inSlice "pawn6.svg" .TakenPawns}}disabled{{end}}> <img src="../images/tiako.jpg" alt="Tiako" width="64"></label>
            <label><input type="radio" name="pion" value="leto.jpg" {{if inSlice "pawn7.svg" .TakenPawns}}disabled{{end}}> <img src="../images/leto.jpg" alt="Leto" width="64"></label>
            <label><input type="radio" name="pion" value="plk.jpg" {{if inSlice "pawn8.svg" .TakenPawns}}disabled{{end}}> <img src="../images/plk.jpg" alt="PLK" width="64"></label>
            <label><input type="radio" name="pion" value="niska.jpg" {{if inSlice "pawn9.svg" .TakenPawns}}disabled{{end}}> <img src="../images/niska.jpg" alt="Niska" width="64"></label>
            <label><input type="radio" name="pion" value="jul.jpg" {{if inSlice "pawn10.svg" .TakenPawns}}disabled{{end}}> <img src="../images/jul.jpg" alt="Jul" width="64"></label>
        </div>
        <button type="submit">Valider Joueur 2</button>
    </form>
    </section>
    </div>
<section class="board-section">
    <h2 class="plateau">JOUER</h2>
    <form method="post" action="/grille">
        <div class="board">
            <div class="buttons">
                <button type="submit" name="col" value="0">‚ñº</button>
                <button type="submit" name="col" value="1">‚ñº</button>
                <button type="submit" name="col" value="2">‚ñº</button>
                <button type="submit" name="col" value="3">‚ñº</button>
                <button type="submit" name="col" value="4">‚ñº</button>
                <button type="submit" name="col" value="5">‚ñº</button>
                <button type="submit" name="col" value="6">‚ñº</button>
            </div>
        </div>
    </form>
</section>
</table>
    <!-- üéµ Script consolid√© : jouer son √† la s√©lection et avant submit des colonnes -->
<script>
/* play sound derived from image filename:
   image example "../images/booba.png" -> soundtrack "/soundtrack/booba.mp3" */
function soundUrlFromImageFilename(filename) {
  if (!filename) return null;
  const base = filename.split('/').pop();
  const name = base.split('.').slice(0, -1).join('.');
  return '/soundtrack/' + name.toLowerCase() + '.mp3';
}

document.addEventListener('DOMContentLoaded', () => {
  // Quand on change un radio (s√©lection imm√©diate)
  document.querySelectorAll('input[name="pion"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const filename = e.target.value;
      const form = e.target.closest('form');
      const player = form && form.querySelector('input[name="joueur"]') ? form.querySelector('input[name="joueur"]').value : '1';
      try {
        localStorage.setItem('pawn_player_' + player, filename);
        if (!localStorage.getItem('currentPlayer')) localStorage.setItem('currentPlayer', '1');
      } catch (err) { /* ignore localStorage errors */ }

      const url = soundUrlFromImageFilename(filename);
      if (url) {
        const a = new Audio(url);
        a.currentTime = 0;
        a.play().catch(()=>{});
      }
    });
  });

  // Lors de la validation (submit) des forms de s√©lection, on conserve le comportement existant
  document.querySelectorAll('form[action="/joueur"]').forEach(form => {
    form.addEventListener('submit', () => {
      const selected = form.querySelector('input[name="pion"]:checked');
      if (selected) {
        const url = soundUrlFromImageFilename(selected.value);
        if (url) {
          const a = new Audio(url);
          a.currentTime = 0;
          a.play().catch(()=>{});
        }
      }
      // on laisse la soumission se faire normalement
    });
  });

  // Boutons de colonne : emp√™cher submit imm√©diat, jouer son, puis soumettre
  document.querySelectorAll('form[action="/grille"] .buttons button, .board .buttons button').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const form = btn.closest('form') || document.querySelector('form[action="/grille"]');

      // helper : set hidden input[name="col"] then submit
      function setColAndSubmit(formEl, val) {
        if (!formEl) return;
        let hidden = formEl.querySelector('input[name="col"].js-hidden-col');
        if (!hidden) {
          hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = 'col';
          hidden.className = 'js-hidden-col';
          formEl.appendChild(hidden);
        }
        hidden.value = String(val);
        formEl.submit();
      }

      try {
        const cp = localStorage.getItem('currentPlayer') || '1';
        const pawn = localStorage.getItem('pawn_player_' + cp);
        const url = soundUrlFromImageFilename(pawn);
        if (url) {
          const audio = new Audio(url);
          audio.currentTime = 0;
          audio.play().then(() => {
            // attendre que le son d√©marre puis envoyer la valeur de la colonne
            setTimeout(() => setColAndSubmit(form, btn.value), 80);
          }).catch(() => {
            // fallback : submit apr√®s court d√©lai
            setTimeout(() => setColAndSubmit(form, btn.value), 80);
          });
          return;
        }
      } catch (err) { /* ignore */ }

      // pas de son disponible : submit imm√©diat (avec valeur)
      setColAndSubmit(form, btn.value);
    });
  });
});
</script>
<div id="board"></div>
<script>
  const ROWS = 6;
  const COLS = 7;
  const boardDiv = document.getElementById("board");
  let board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));

  function renderBoard() {
    boardDiv.innerHTML = "";
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        const cell = document.createElement("div");
        cell.textContent = board[r][c] === 0 ? "." : board[r][c];
        cell.addEventListener("click", () => playMove(c));
        boardDiv.appendChild(cell);
      }
    }
  }

  function playMove(col) {
    for (let r = ROWS - 1; r >= 0; r--) {
      if (board[r][col] === 0) {
        board[r][col] = 1; // exemple : joueur 1
        renderBoard();
        return;
      }
    }
    alert("Colonne pleine !");
  }

  renderBoard();
</script>
<div class="Jeu">
  <style>
    .grid { border-collapse: collapse; margin: 12px 0; }
    .grid td { width: 56px; height: 56px; border: 2px solid #123; background: #87cefa; text-align:center; vertical-align:middle; }
    .cell-empty { width:40px; height:40px; border-radius:50%; background:#fff; margin:auto; }
    .pawn { width:40px; height:40px; border-radius:50%; display:block; margin:auto; }
    .controls { margin-bottom:8px; }
    .scores { margin-top:8px; }
  </style>
</head>
<body>
  <h1>Puissance 4</h1>
  <p>Joueur courant: {{.Player}} ‚Äî √âtat: {{.State}}</p>

  <form method="post" action="/grille">
    <p><a href="/grille">Aller au plateau</a></p>
    <div class="controls">
      {{range $i := seq 7}}
        <button type="submit" name="col" value="{{$i}}">‚ñº</button>
      {{end}}
    </div>
  </form>

  <table class="grid" role="grid" aria-label="Plateau Puissance 4">
    {{range $r := .Grid}}
      <tr>
        {{range $c := $r}}
          <td>
            {{if eq $c 0}}
              <div class="cell-empty"></div>
            {{else if eq $c 1}}
              <img src="{{$.PawnImg1}}" alt="Pion 1" class="pawn">
            {{else}}
              <img src="{{$.PawnImg2}}" alt="Pion 2" class="pawn">
            {{end}}
          </td>
        {{end}}
      </tr>
    {{end}}
  </table>

  <div class="scores">
    <strong>Score:</strong> Joueur 1 = {{.Score1}} ‚Äî Joueur 2 = {{.Score2}}
  </div>

  <p><a href="/">Retour accueil</a></p>
</body>
</html>
